<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>云监控系统</title>
    <link rel="stylesheet" href="css/reset.css"/>
    <link rel="stylesheet" href="css/scanboard.css"/>
    <link rel="stylesheet" href="css/animsition.css"/>
    <link rel="stylesheet" href="css/jquery.shCircleLoader.css"/>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" media="all" href="css/daterangepicker-bs3.css">
    <link rel="stylesheet" media="all" href="css/daterangepicker-1.3.7.css">
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="js/echarts.min.js"></script>
    <script type="text/javascript" src="js/echartsOptions.js"></script>
    <script type="text/javascript" src="js/errCode.js"></script>
    <script type="text/javascript" src="js/device.js"></script>
    <script type="text/javascript" src="js/provincecity.js"></script>
    <script type="text/javascript" src="js/jquery.shCircleLoader-min.js"></script>
    <script type="text/javascript" src="js/districtCode.js"></script>
    <script type="text/javascript" src="js/time.js"></script>
    <script type="text/javascript" src="js/map/china.js"></script>
    <script type="text/javascript" src="js/scanboard.js"></script>
    <script type="text/javascript" src="js/fontscroll.js"></script>
    <script type="text/javascript" src="js/jquery.animsition.js"></script>
    <script type="text/javascript" src="js/jquery.nicescroll.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/moment.js"></script>
    <script type="text/javascript" src="js/daterangepicker-1.3.7.js"></script>
    <script type="text/javascript" src="js/jquery.table2excel.js"></script>
    <script type="text/javascript"
            src="http://webapi.amap.com/maps?v=1.4.3&key=f8ffe058b8e6f5b05e8ff43ca4207393"></script>
</head>
<body>
<div id="loader">
</div>
<!--<canvas id="canvas"></canvas>-->
<div class="scanboardWp animsition">
    <div id="top">
        <div class="wp clearfix">
            <div class="left pageTit">
                <img src="images/wayzim.png"/>
            </div>
            <div class="center topLogo">
                <a href="#">云监控系统</a>
            </div>
            <div class="right topBar">
                <div class="topTime">时间加载中...</div>
                <div class="clearfix">
                    <div class="company fr">
                        <h3>中科微至</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--Top End!-->

    <!--Main Start!-->
    <div id="main" class="wp clearfix">
        <div class="left">
            <!--报警信息-->
            <div class="item1">
                <div class="itemTit">
                    <span class="border-yellow">报警信息--AlarmType</span>
                </div>
                <div id="alarmType" class="content"></div>
            </div>

            <div class="item2">
                <div class="itemTit">
                    <span class="border-green">设备类型--DeviceType</span>
                </div>
                <div class="content" id="deviceType">
                </div>
            </div>

            <div class="item3">
                <div class="itemTit">
                    <span class="border-blue">报警数量统计--AlarmCount</span>
                </div>
                <div id="alarmCount" class="content">
                </div>
            </div>
        </div>

        <div class="center">
            <!--            <div class="center-top">-->
            <div id="btn"><img src="images/backB.png" id="back" class="hidden"/></div>
            <!--                <div class="btnLayer">-->
            <!--                    <div class="search">-->
            <!--                        <div class="searchInner">-->
            <!--                            <a href="javascript:;" class="searchBtn"><span class="icoSearch"></span></a>-->
            <!--                            <form class="searchForm">-->
            <!--                                <button class="icoSearch"></button>-->
            <!--                                <input type="text" name="" placeholder="请搜索城市">-->
            <!--                            </form>-->
            <!--                        </div>-->
            <!--                    </div>-->
            <!--                    							<a href="javascript:;" class="infoBtn"><span class="icoCar"></span></a>-->
            <!--                </div>-->
            <div id="china-map" class="content">
            </div>
            <!--            </div>-->
            <!--            <div class="center-bottom">-->
            <!--                <div class="itemTit">-->
            <!--                    <span class="border-blue">月报警统计图<small>(2017年12月)</small></span>-->
            <!--                </div>-->
            <!--            </div>-->
            <div class="hidden" id="station">
                <table width="100%" id="tableInfo">
                    <thead>
                    <tr>
                        <th>站点名</th>
                        <th>分拣线编号</th>
                        <th>设备类型</th>
                        <th>设备序号</th>
                        <th>设备状态</th>
                        <th>报警时间</th>
                    </tr>
                    </thead>
                    <tbody id="stationInfo" class="table2">
                    </tbody>
                </table>
            </div>
            <!--                            <div class="billChart">-->
            <!--                                <div class="itemTit">-->
            <!--                                    <span class="border-blue">描述.......<small></small></span>-->
            <!--                                </div>-->
            <!--                                <div id="myChart1"></div>-->
            <!--                            </div>-->
        </div>
    </div>

    <div class="right">
        <div class="total1">
            <div class="itemTit">
                <span class="border-yellow">报警预测--AlarmPrediction</span>
            </div>
            <div id="guestDiv"><img src="images/backB.png" id="backGuest" class="hidden" onclick="guestBtn()"/>
            </div>
            <div class="hidden" id="guestType"></div>
            <div class="content" id="guestTable">
                <table id="tableY">
                    <thead>
                    <tr>
                        <th>设备编号</th>
                        <th>预测分析</th>
                    </tr>
                    </thead>
                    <tbody id="guest"></tbody>
                </table>
            </div>
        </div>

        <div class="total2">
            <div class="itemTit">
                <span class="border-green">各地区情况--RegionStatement</span>
            </div>
            <div class="content" id="tableBox">
                <table width=100% class="tab-scroll">
                    <thead class="thead1">
                    <tr>
                        <th>地区名</th>
                        <th>站点数</th>
                        <th>分拣线数</th>
                        <th>报警数量</th>
                    </tr>
                    </thead>
                    <tbody id="tableNode" class="table1">
                </table>
            </div>
        </div>
    </div>
</div>
<div class="popup">
    <a href="javascript:;" class="popupClose"></a>
    <div class="summary">
        <!--        <div class="summaryTop">-->
        <div class="itemTit">
            <span class="border-green">设备类型报警各区域统计</span>
        </div>
        <div>
            <select id="selectType" onchange="">
                <option value="">--选择设备类型--</option>
                <option value="1">相机</option>
                <option value="2">尺寸测量仪</option>
                <option value="4">分拣板卡</option>
                <option value="7">动态称</option>
                <option value="101">电机</option>
                <option value="102">光电</option>
                <option value="104">驱动器</option>
            </select>
        </div>
        <!--        <div class="page-content">-->
        <!-- BEGIN PAGE CONTAINER-->
        <div id="chooseCalender">
                <font color="white" style="font-size: 15px;padding-top: 0.5%">选择日期：</font>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span4">
                    <div class="control-group">
                        <div class="controls">
                            <div id="reportrange" class="pull-left dateRange" style="width:350px">
                                <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                                <span id="searchDateRange"></span>
                                <!--                                    <b class="caret"></b>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="searchDiv">
            <img src="images/icon_search.png" id="searchImage">
        </div>
        <div>
            <img src="images/导出EX.png" onclick="exportExcel()" id="exportBtn">
        </div>
        <!--        </div>-->
            <div>
                <table width=100% class="tableType">
                    <thead class="thead1">
<!--                    <tr>-->
<!--                        <th>省份</th>-->
<!--                        <th>城市</th>-->
<!--                        <th>站点名</th>-->
<!--                        <th>报警数量</th>-->
<!--                    </tr>-->
                    </thead>
                    <tbody id="tableType">
                </table>
            </div>
            <!--        </div>-->
            <!--        <div class="summaryBottom">-->
            <!--            <div class="itemTit">-->
            <!--                <span class="border-red">设备类型报警历史数据</span>-->
            <!--            </div>-->
            <!--           -->
            <!--        </div>-->
        </div>
        <!--Main End!-->
    </div>


    <script>
        $('#loader').shCircleLoader({color: "#00deff"});
        var alarmType = echarts.init(document.getElementById("alarmType"), null, {devicePixelRatio: 2.5});
        var deviceType = echarts.init(document.getElementById("deviceType"), null, {devicePixelRatio: 2.5});
        var alarmCount = echarts.init(document.getElementById("alarmCount"), null, {devicePixelRatio: 2.5});
        var guestType = echarts.init(document.getElementById('guestType'), null, {devicePixelRatio: 2.5});
        var myChart = echarts.init(document.getElementById('china-map'), null, {devicePixelRatio: 2.5});
        var oBack = document.getElementById("back");

        var seriesData = [];
        for (var i = 0; i < toolTipData.length; i++) {
            seriesData[i] = {};
            seriesData[i].name = toolTipData[i].provinceName;
            seriesData[i].value = toolTipData[i].alarmCount;
            seriesData[i].provinceKey = toolTipData[i].provinceKey;
        }

        var seriesDataPro = [];
        for (var i = 0; i < provinceData.length; i++) {
            seriesDataPro[i] = {};
            seriesDataPro[i].name = provinceData[i].cityName;
            seriesDataPro[i].value = provinceData[i].alarmCount;
        }
        var selectTime=new Array();
        window.onload = function () {
            alarmAllProvince();
            // allAlarmCity();
            guest();
            allZCity();
            getAlarm();
            getDeviceAlarm()
            getAlarmCount()
            getDeviceTime()

        };
        setInterval("allFunction()", 1000 * 60)

        function allFunction() {
            alarmTypeOption.series[0]["data"] = []
            getAlarm()
            deviceTypeOption.series[0]["data"] = []
            getDeviceAlarm()
            alarmCountOption.series[0]["data"] = []
            getAlarmCount()
            alarmCountOption.xAxis[0]["data"] = []
            getDeviceTime()

        }


        setInterval(function () {
            alarmType.setOption(alarmTypeOption, true)
        }, 500)
        setInterval(function () {
            deviceType.setOption(deviceTypeOption, true);
        }, 500);
        setInterval(function () {
            alarmCount.setOption(alarmCountOption, true);
        }, 500);


        //弹窗
        deviceType.on('click', function () {
            $('.filterbg').show();
            $('.popup').show();
            $('.popup').width('3px');
            $('.popup').animate({height: '76%'}, 400, function () {
                $('.popup').animate({width: '82%'}, 400);
            });
            setTimeout(summaryShow, 800);
        });
        $('.popupClose').on('click', function () {
            $('.popupClose').css('display', 'none');
            $('.popup').animate({width: '3px'}, 400, function () {
                $('.popup').animate({height: 0}, 400);
            });
            setTimeout(summaryHide, 800);
        });

        function summaryShow() {
            $('.popupClose').css('display', 'block');
            $('.summary').show();
        };

        function summaryHide() {
            $('.filterbg').hide();
            $('.popup').hide();
            $('.popup').width(0);
        };


        //导出表格
        function exportExcel(){
            $('.tableType').table2excel({
                name: "Excel Document Name",
                //文件名
                filename: (function () {
                    if (selectTime.start===undefined&&selectTime.end===undefined){
                        return deviceArray[$("#selectType").val()]
                    }else if( dateDay(selectTime.start)==dateDay(selectTime.end)){
                        return deviceArray[$("#selectType").val()]+"-"+dateDay(selectTime.start)
                    }else {
                        return deviceArray[$("#selectType").val()]+"-"+dateDay(selectTime.start)+"-"+dateDay(selectTime.end)
                    }
                    })(),
                fileext: ".xls"
            })
        }
        //预测分析点击查看
        $("#tableY tbody").on("click", "tr", function () {
            let td = $(this).find("td");
            let text = td.eq(0).text();
            guestData(text)
            $('#backGuest').removeClass('hidden');
            $('#guestTable').removeClass('content').addClass('hidden');
            $('#guestType').removeClass('hidden').addClass('content');
        });

        function guestBtn() {
            $('#backGuest').addClass('hidden')
            $('#guestType').removeClass('content').addClass('hidden');
            $('#guestTable').removeClass('hidden').addClass('content');
            guestOption.xAxis[0]["data"] = []
            guestOption.series[0]["data"] = [];
            guest()
        }

        //报警区域点击查看
        $('.tableType tbody').on('click','tr',function () {
            console.log('孙丽亮')
            let td=$(this).find('td')
            let text=td.eq(2).text()
            $('.tableType').html()
            getStationInfo(text)
        })
        //报警类型饼图
        function getAlarm() {
            var nameD = ['报警', '未连接', '子设备报警'];
            var state = [1, 2, 3];
            for (let i = 0; i < state.length; i++) {
                stateType(state[i]);
                function stateType(e) {
                    $.ajax({
                        url: "device/queryDeviceState",
                        dataType: "JSON",
                        type: "POST",
                        data: {stateType: e},
                        success: function (data) {
                            alarmTypeOption.series[0]["data"].push({"value": data.data, "name": nameD[i]});
                        }
                    })
                }
            }
        }
        //设备类型
        function getDeviceAlarm() {
            var nameData = ['相机', '尺寸测量仪', '分拣板卡', '动态称', '电机', '光电', '驱动器'];
            var deviceId = [1, 2, 4, 7, 101, 102, 104];
            let array=new Array()
            for (let i = 0; i < deviceId.length; i++) {
                device(deviceId[i]);
                function device(e) {
                    $.ajax({
                        url: "device/queryDeviceType",
                        dataType: "JSON",
                        data: {type: e},
                        type: "POST",
                        success: function (data) {
                            array.push({"value": data.data, "name": nameData[i]})
                            array.sort((a,b)=> b.value-a.value)
                            setTimeout(function () {
                                for (let j=0;j<array.length;j++){
                                    deviceTypeOption.legend.data.push(array[j].name)
                                }
                            },200)
                            deviceTypeOption.series[0]["data"]=array
                        }
                    });
                }
            }
        }
        //转换时间戳
        const dateToStamp=function(date){
            date=date.replace(/-/g,'/')
            var timestamp=new Date(date).getTime();
            return timestamp
        }
        //区域报警类型汇总
        $('#searchImage').on('click',function() {
            let e = $('#selectType').val();
            let start=selectTime["start"]
            let end=selectTime["end"]
            console.log(start,end)
            $.ajax({
                url: "device/queryStateByDistrictTime",
                dataType: "JSON",
                data: {type: e,startTime:start,endTime:end},
                type: "GET",
                success: function (data) {
                    let a="省份",b="城市",c="站点名",d="报警数量",e="报警信息",f="查看";
                    let content = ""
                    let contentHead=""
                    for (let i = 0; i < data.data.length; i++) {
                        content += "<tr><td>" + data.data[i][0] + "</td>"
                            + "<td style='color: chartreuse'>" + data.data[i][1] + "</td>"
                            + "<td style='color: white'>" + data.data[i][2] + "</td>"
                            + "<td style='color: white'>" + data.data[i][3] + "</td>"
                            + "<td style='color: white'>" + f + "</td></tr>";
                    }
                    contentHead+="<tr><th>"+a+"</th><th>"+b+"</th><th>"+c+"</th><th>"+d+"</th><th>"+e+"</th></tr>"
                    $(".thead1").html(contentHead)
                    $("#tableType").html(content)
                }
            });
        })
        //下查区域报警信息
        function getStationInfo(e){
            let type=parseInt($('#selectType').val())
            let startTime=selectTime.start
            let endTime=selectTime.end
            if(e===undefined) e={}
            $.ajax({
                url:'device/queryStationInfo',
                data:{type:type,name:e,startTime:startTime,endTime:endTime},
                type:"JSON",
                success:function (data) {
                    let a='站点名',b='分拣线编号', c='设备类型',d='设备序号',f='设备状态',g='报警时间'
                    let content=''
                    let contentHead=''
                    contentHead+="<tr><th>"+a+"</th><th>"+b+"</th><th>"+c+"</th><th>"+d+"</th><th>"+f+"</th><th>"+g+"</th></tr>";
                    content += "<tr><td>" + data.data[i][0] + "</td><td style='color: #00deff'>" + data.data[i][1] + "</td><td>" + deviceCode[data.data[i][2]] + "</td>" +
                        "<td>" + data.data[i][3] + "</td><td style='color: #FF7F00'>" + alarmIn[data.data[i][2]][data.data[i][4]] + "</td><td style='color: #ffd220'>" + dateTo(dateHour(new Date(data.data[i][5]))) + "</td></tr>";
                    $('.tableType thead').html(contentHead)
                    $('#tableType').html(content)
                }
            })
        }
        //日历
        $(document).ready(function () {
            //时间插件
            $('#reportrange span').html(moment().subtract('hours', 1).format('YYYY-MM-DD HH:mm:ss') + ' - ' + moment().format('YYYY-MM-DD HH:mm:ss'));
            $('#reportrange').daterangepicker(
                {
                    // startDate: moment().startOf('day'),
                    //endDate: moment(),
                    //minDate: '01/01/2012',	//最小时间
                    maxDate: moment(), //最大时间
                    dateLimit: {
                        days: 30
                    }, //起止时间的最大间隔
                    showDropdowns: true,
                    showWeekNumbers: false, //是否显示第几周
                    timePicker: true, //是否显示小时和分钟
                    timePickerIncrement: 60, //时间的增量，单位为分钟
                    timePicker12Hour: false, //是否使用12小时制来显示时间
                    ranges: {
                        //'最近1小时': [moment().subtract('hours',1), moment()],
                        '今日': [moment().startOf('day'), moment()],
                        '昨日': [moment().subtract('days', 1).startOf('day'), moment().subtract('days', 1).endOf('day')],
                        '最近7日': [moment().subtract('days', 6), moment()],
                        '最近30日': [moment().subtract('days', 29), moment()]
                    },
                    opens: 'right', //日期选择框的弹出位置
                    buttonClasses: ['btn btn-default'],
                    applyClass: 'btn-small btn-primary blue',
                    cancelClass: 'btn-small',
                    format: 'YYYY-MM-DD HH:mm:ss', //控件中from和to 显示的日期格式
                    separator: ' to ',
                    locale: {
                        applyLabel: '确定',
                        cancelLabel: '取消',
                        fromLabel: '起始时间',
                        toLabel: '结束时间',
                        // customRangeLabel: '自定义',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月',
                            '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: 1
                    }
                },
                function (start, end, label) {//格式化日期显示框
                    $('#reportrange span').html(start.format('YYYY-MM-DD HH:mm:ss') + ' - ' + end.format('YYYY-MM-DD HH:mm:ss'));
                    selectTime["start"]=start.format('YYYY-MM-DD HH:mm:ss')
                    selectTime["end"]=end.format('YYYY-MM-DD HH:mm:ss')
                }
                );

            //设置日期菜单被选项  --开始--
            var dateOption;
            if ("${riqi}" == 'day') {
                dateOption = "今日";
            } else if ("${riqi}" == 'yday') {
                dateOption = "昨日";
            } else if ("${riqi}" == 'week') {
                dateOption = "最近7日";
            } else if ("${riqi}" == 'month') {
                dateOption = "最近30日";
            }
            // else if ("${riqi}" == 'year') {
            //     dateOption = "最近一年";
            //  }
            // else {
            //     dateOption = "自定义";
            // }
            $(".daterangepicker").find("li").each(function () {
                if ($(this).hasClass("active")) {
                    $(this).removeClass("active");
                }
                if (dateOption == $(this).html()) {
                    $(this).addClass("active");
                }
            });
            //设置日期菜单被选项  --结束--
        })
        //分时数量统计
        function getDeviceTime() {
            var n = new Date();
            var now = dateHour(n);
            var now1 = dateHour(new Date(n.setHours(new Date().getHours() - 1)));
            var now2 = dateHour(new Date(n.setHours(new Date().getHours() - 2)));
            var now3 = dateHour(new Date(n.setHours(new Date().getHours() - 3)));
            var dateArr = [dateToStr(now3), dateToStr(now2), dateToStr(now1), dateToStr(now)];
            for (var i = 0; i < 4; i++) {
                alarmCountOption.xAxis[0]["data"].push(dateArr[i]);
            }
        }

        function getAlarmCount() {
            $.ajax({
                url: "device/timeCount",
                dataType: "JSON",
                type: "POST",
                success: function (data) {
                    for (let i = 0; i < data.data.length; i++) {
                        alarmCountOption.series[0]["data"].push(data.data[i])
                    }
                }
            });
        }

        //点击表格行获取该行所有数据
        function cityInfo(e) {
            if (e === undefined) e = {};
            $.ajax({
                url: "city/queryCityInfo",
                dataType: "JSON",
                type: "POST",
                data: {province: e},
                success: function (data) {
                    let content = "";
                    for (let i = 0; i < data.data.length; i++) {
                        content += "<tr><td>" + data.data[i][0] + "</td>"
                            + "<td style='color: chartreuse'>" + data.data[i][1] + "</td>"
                            + "<td style='color: white'>" + data.data[i][2] + "</td>"
                            + "<td style='color: red'>" + data.data[i][3] + "</td></tr>";
                        $("#tableNode").empty().html(content)
                    }
                }
            })
        }

        function guest(e) {
            if (e === undefined) e = {}
            $.ajax({
                url: "getMap",
                dataType: "JSON",
                type: "POST",
                success: function (data) {
                    let c = '查看'
                    let content = ""
                    for (var key in data.data) {
                        content += "<tr><td>" + key + "</td><td><button id='btnAlarm' style='background: transparent'><font color='#87ceeb'>" + c + "</font></button></td></tr>"
                    }
                    $('#guest').empty().html(content);
                }
            })
        }

        function getStationName(e) {
            $.ajax({
                url: "device/queryName",
                dataType: "text",
                data: {stationName: e},
                type: "GET",
                success: function (data) {
                    var arr = data.data.split(",")
                    let content = ''
                    content += arr[0] + " " + arr[1] + " " + deviceCode[parseInt(arr[2], 10)];
                    guestOption.title.text = content
                    guestType.setOption(guestOption, true)
                },
            })
        }

        //预测分析折线图
        function guestData(e) {
            $.ajax({
                url: "getMap",
                dataType: "JSON",
                type: "POST",
                success: function (data) {
                    let json = JSON.parse(data[e]);
                    for (let i = 0; i < json.length; i++) {
                        guestOption.xAxis[0]["data"].push(dateTo(json[i]["ds"]))
                        guestOption.series[0]["data"].push(Math.round(json[i]["yhat"]))
                    }
                    getStationName(e)
                }
            })
        }

        //设备报警详情
        function stationInfo(e) {
            if (e == undefined) e = {};
            $.ajax({
                    url: "city/queryStationInfo",
                    dataType: "JSON",
                    data: {city: e},
                    type: "POST",
                    success: function (data) {
                        let content = "";
                        for (let i = 0; i < data.data.length; i++) {
                            content += "<tr><td>" + data.data[i][0] + "</td><td style='color: #00deff'>" + data.data[i][1] + "</td><td>" + deviceCode[data.data[i][2]] + "</td>" +
                                "<td>" + data.data[i][3] + "</td><td style='color: #FF7F00'>" + alarmIn[data.data[i][2]][data.data[i][4]] + "</td><td style='color: #ffd220'>" + dateTo(dateHour(new Date(data.data[i][5]))) + "</td></tr>";
                            $('#stationInfo').empty().html(content);
                        }
                    }
                }
            )
        }

        function alarmAllProvince(e) {
            if (e === undefined) e = {};
            $.ajax({
                url: "province/queryProvinceInfo",
                dataType: "JSON",
                type: "GET",
                data: e,
                success: function (data) {
                    for (let i = 0; i < data.data.length; i++) {
                        for (let j = 0; j < toolTipData.length; j++) {
                            if (data.data[i][0] == toolTipData[j].provinceName || data.data[i][0] == seriesData[j]) {
                                seriesData[j].value = data.data[i][3];
                                toolTipData[j].alarmCount = data.data[i][3];
                            }
                        }
                    }
                    let content = "";
                    for (let i = 0; i < data.data.length; i++) {
                            content += "<tr><td>" + data.data[i][0] + "</td>"
                                + "<td style='color: chartreuse'>" + data.data[i][1] + "</td>"
                                + "<td style='color: white'>" + data.data[i][2] + "</td>"
                                + "<td style='color: #FF2400'>" + data.data[i][3] + "</td></tr>";
                            $("#tableNode").empty().html(content)
                    }
                    allAlarmCity();
                    initEcharts('china', '中国')
                }
            })
        }
        //直辖市
        function allZCity(e) {
            if (e === undefined) e = {}
            $.ajax({
                url: "city/queryZCityAlarm",
                data: e,
                dataType: "JSON",
                type: "POST",
                success: function (data) {
                    for (let i = 0; i < data.data.length; i++) {
                        for (let j = 0; j < provinceData.length; j++) {
                            if (data.data[i].district == provinceData[j].cityName || data.data[i].district == seriesDataPro[j].name) {
                                seriesDataPro[j].value = data.data[i].alarmCount;
                                provinceData[j].alarmCount = data.data[i].alarmCount;
                            }
                        }
                    }
                }
            })
        }
        //所有城市信息
        function allAlarmCity(e) {
            if (e === undefined) e = {};
            $.ajax({
                url: "city/queryAlarmCity",
                dataType: "JSON",
                type: "GET",
                data: e,
                success: function (data) {
                    for (let i = 0; i < data.data.length; i++) {
                        for (let j = 0; j < provinceData.length; j++) {
                            if (data.data[i].city == provinceData[j].cityName || data.data[i].city == seriesDataPro[j].name) {
                                seriesDataPro[j].value = data.data[i].alarmCount;
                                provinceData[j].alarmCount = data.data[i].alarmCount;
                            }
                        }
                    }
                }
            })
        }

        //直辖市
        function cq(e) {
            $.ajax({
                url: "city/queryStationDistrict",
                dataType: "JSON",
                type: "POST",
                data: {district: e},
                success: function (data) {
                    let content = "";
                    for (let i = 0; i < data.data.length; i++) {
                        content += "<tr><td>" + data.data[i][0] + "</td><td>" + data.data[i][1] + "</td><td>" + deviceCode[data.data[i][2]] + "</td>" +
                            "<td>" + data.data[i][3] + "</td><td>" + alarmIn[data.data[i][2]][data.data[i][4]] + "</td><td>" + dateTo(dateHour(new Date(data.data[i][5]))) + "</td></tr>";
                        $('#stationInfo').empty().html(content);
                    }

                }
            })
        }
        //滚动表格
        //先在table的最后增加一行，然后再把第一行中的数据填充到新增加的行中，最后再删除table的第一行
        // function change(table){
        //     var row = table.insertRow(table.rows.length);//在table的最后增加一行,table.rows.length是表格的总行数
        //     if (table.rows.length>10){
        //         for (j = 0; j < table.rows[0].cells.length; j++) {//循环第一行的所有单元格的数据，让其加到最后新加的一行数据中（注意下标是从0开始的）
        //             var cell = row.insertCell(j);//给新插入的行中添加单元格
        //             // cell.height = "24px";//一个单元格的高度，跟css样式中的line-height高度一样
        //             cell.innerHTML = table.rows[0].cells[j].innerHTML;//设置新单元格的内容，这个根据需要，自己设置
        //         }
        //         table.deleteRow(0);//删除table的第一行
        //     }
        // };
        // function tableInterval(){
        //     var table = document.getElementById("tableNode");//获得表格
        //     change(table);//执行表格change函数，删除第一行，最后增加一行，类似行滚动
        // };
        // setInterval("tableInterval()",2000);//每隔 秒执行一次change函数，相当于table在向上滚动一样

        //查询当天的报警信息的详细信息
        var max = 80;
        var min = 0; // 侧边最大值最小值
        var maxSize4Pin = 100,
            minSize4Pin = 30;
        var mapName = '';
        var mapKey = "";
        var mapProvince = "";

        function getGeoCoordMap(name) {
            name = name ? name : 'china';
            /*获取地图数据*/
            var geoCoordMap = {};
            var mapFeatures = echarts.getMap(name).geoJson.features;
            mapFeatures.forEach(function (v) {
                var name = v.properties.name; // 地区名称
                geoCoordMap[name] = v.properties.cp; // 地区经纬度
            });
            return geoCoordMap;
        }

        function convertData(data) {
            var geoCoordMap = getGeoCoordMap(mapName);
            var res = [];
            for (var i = 0; i < data.length; i++) {
                var geoCoord = geoCoordMap[data[i].name];
                if (geoCoord) { // 如果数据data对应上，
                    res.push({
                        name: data[i].name,
                        value: geoCoord.concat(data[i].value),
                        // alarmCount: data[i].value
                    });
                }
            }
            return res;
        };


        //初始化中国地图
        function initEcharts(pName, Chinese_) {
            myChart.showLoading(); // loading start
            var tmpSeriesData = pName === "china" ? seriesData : seriesDataPro;
            var tmp = pName === "china" ? toolTipData : provinceData;

            var option = {
                // title: {
                //     text: '云监控系统',
                //     top: 'top',
                //     textStyle:{
                //         color:'#FFF'
                //     }
                // },
                noDataLoadingOption: {
                    text: '无数据',
                    effect: 'bubble',
                    effectOption: {
                        effect: {
                            n: 0
                        }
                    }
                },
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove',
                    formatter:
                        function (params) { // 鼠标滑过显示的数据
                            if (pName === "china") {
                                var toolTiphtml = "";
                                for (let i = 0; i < tmp.length; i++) {
                                    if (params.name == tmp[i].provinceName) {
                                        toolTiphtml +=
                                            // "<ul id='plan'><li style='font-size: 16px'><span><img src='../static/images/address.png'></span><span>"+tmp[i].provinceName+"" +
                                            // "</span></li><li style='font-size: 16px'>"+'报警数量:'+tmp[i].alarmCount+"</li></ul>"
                                            "<font>" + tmp[i].provinceName + "</font><br><font></font><font>报警数量: </font><font color='yellow'>" + tmp[i].alarmCount + "</font>";
                                    }
                                }
                                return toolTiphtml;
                            } else {
                                var toolTiphtml = ''
                                for (let i = 0; i < tmp.length; i++) {
                                    if (params.name == tmp[i].cityName) {
                                        toolTiphtml += tmp[i].cityName + '<br>报警数量：' + tmp[i].alarmCount;
                                    }
                                }
                                return toolTiphtml;
                            }
                        },
                },
                visualMap: { //视觉映射组件
                    // show: true,
                    // type: 'piecewise',
                    // pieces: [
                    //     {max: 10, color: '#236B8E'},
                    //     {min: 10, max: 20, color: '#38B0DE'},
                    //     {min: 20, max: 100, color: '#0077FF'},
                    //     {min: 100, color: '#4D4DFF'},
                    // ],
                    // outOfRange: {
                    //     color: '#CCCCCC'
                    // },
                    // right: '2%',
                    // bottom: '10%',
                    // textStyle: {
                    //     color: '#FFFFFF'
                    // },
                    // inverse: true, //是否反转 visualMap 组件
                    // seriesIndex: 1, //指定取哪个系列的数据，即哪个系列的 series.data,默认取所有系列
                    show: false,
                    // min: min,
                    // max: max, // 侧边滑动的最大值，从数据中获取
                    left: '5%',
                    top: '96%',
                    inverse: true, //是否反转 visualMap 组件
                    // itemHeight:200,  //图形的高度，即长条的高度
                    text: ['高', '低'], // 文本，默认为数值文本
                    calculable: false, //是否显示拖拽用的手柄（手柄能拖拽调整选中范围）
                    seriesIndex: 1, //指定取哪个系列的数据，即哪个系列的 series.data,默认取所有系列
                    orient: "horizontal",
                    inRange: {
                        color: ['#236B8E', '#1066d5'] // 蓝绿
                    }
                },
                geo: {
                    show: true,
                    map: pName,
                    roam: true,
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 16,
                                color: "#fff",
                                fontFamily: '黑体'
                            } //省份标签字体颜色
                        },
                        emphasis: {
                            show: false,
                        }
                    },
                    itemStyle: {
                        normal: {
                            borderWidth: 1,//设置外层边框
                            borderColor: '#000000',
                            areaColor: "#000000",
                            shadowColor: "#0A5E96",
                            shadowOffsetX: 0,
                            shadowOffsetY: 10,
                            // shadowColor: 'rgba(0,54,255, 1)',
                            // shadowBlur: 150
                        },
                        emphasis: {
                            areaColor: '#fbd456', // 鼠标滑过选中的颜色
                        }
                    }
                },

                series: [
                    {
                        name: 'light',
                        roam: true,
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: tmpSeriesData,
                        symbolSize: function (val) {
                            return 15;
                        },
                        geoIndex: 0,
                        label: {
                            normal: {
                                show: true,
                                formatter: '{b}',
                                position: 'right'
                            },
                            emphasis: {
                                show: true
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: '#FFFFFF' // 字体颜色
                            }
                        }
                    },
                    {
                        name: Chinese_ || pName,
                        type: 'map',
                        mapType: pName,
                        roam: true, //是否开启鼠标缩放和平移漫游
                        zoom: 1,
                        data: tmpSeriesData,
                        animation: false,
                        // top: "3%",//组件距离容器的距离
                        geoIndex: 0,
                        // aspectScale: 1,       //长宽比
                        // showLegendSymbol: true, // 存在legend时显示
                        selectedMode: false,
                        label: {
                            // text:tmpSeriesData,
                            normal: {
                                show: true, //显示省份标签
                                // formatter: "{c}\n{b}",
                                formatter: "{b}",
                                textStyle: {
                                    fontSize: 16,
                                    color: "#fff",
                                    fontFamily: '黑体'
                                } //省份标签字体颜色
                            },
                            emphasis: { //对应的鼠标悬浮效果
                                show: true,
                                textStyle: {
                                    color: "#323232"
                                }
                            }
                        },
                        itemStyle: {
                            normal: {
                                // areaColor: '#F0A809',
                                // borderColor: 'transparent',
                                // borderWidth: 1
                                areaColor: "#013C62",
                                borderColor: "#0A5E96",
                                borderWidth: 2

                            },
                            emphasis: {
                                areaColor: '#F0A809'
                            }
                        },
                    },
                    {
                        name: '点',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        roam: true,
                        symbol: 'pin',//气泡
                        symbolSize:
                            function (val) {
                                if (val[2] === 0)
                                    return 0;
                                var a = (maxSize4Pin - minSize4Pin) / (max - min);
                                var b = minSize4Pin - a * min;
                                b = maxSize4Pin - a * max;
                                return a * val[2] + b;
                            },
                        label: {
                            normal: {
                                show: true,
                                formatter: function (params) {
                                    return params.data.value[2];
                                },
                                textStyle: {
                                    color: '#fff',
                                    fontSize: 12
                                }
                            }
                        },

                        itemStyle: {
                            normal: {
                                color: 'red' //标志颜色'#F62157'
                            }
                        },
                        zlevel: 6,
                        data: convertData(tmpSeriesData),
                    },
                    // {
                    //     name: 'Top 10',
                    //     type: 'effectScatter',
                    //     coordinateSystem: 'geo',
                    //     data:
                    //         convertData(seriesData.sort(function (a, b) {
                    //         return b.value - a.value;
                    //     }).slice(0,10)),
                    //     symbolSize: function (val) {
                    //         // var a = (maxSize4Pin - minSize4Pin) / (max - min);
                    //         // var b = minSize4Pin - a * min;
                    //         // b = maxSize4Pin - a * max;
                    //         // return a * val[2] + b;
                    //         return 15;
                    //     },
                    //     showEffectOn: 'render',
                    //     rippleEffect: {
                    //         brushType: 'stroke'
                    //     },
                    //     hoverAnimation: true,
                    //
                    //     itemStyle: {
                    //         normal: {
                    //             color: '#fbe903',
                    //             shadowBlur: 10,
                    //             shadowColor: '#dece00'
                    //         }
                    //     },
                    //     // zlevel: 1
                    // },

                ]
            }
            // option.geo.map=pName
            // option.series[0]['data'].push(tmpSeriesData)
            // option.series[1].name=Chinese_ || pName
            // option.series[1].mapType=pName
            // option.series[1]['data'].push(tmpSeriesData)
            // option.series[2]['data'].push(convertData(tmpSeriesData))

            // 针对海南放大
            if (pName == '海南省') {
                option.series[1].center = [109.844902, 19.0392];
                option.series[1].layoutCenter = ['50%', '50%'];
                option.series[1].layoutSize = "300%";
                // } else if (pName !== 'china') {
                //     option.series[1].center = undefined;
                //     option.series[1].layoutCenter = ['50%', '50%'];
                //     option.series[1].layoutSize = '70%';
            } else {
                option.series[1].center = undefined;
                option.series[1].layoutCenter = undefined;
                option.series[1].layoutSize = undefined;
            }
            myChart.setOption(option, true);
            window.$(window).resize(function () {
                myChart.resize();
                // alarmType.resize();
                deviceType.resize();
                alarmCount.resize();
                guestType.resize();
            });

            myChart.off("click");

            if (pName === "china") { // 全国时，添加click 进入省级
                // setInterval(function () {
                //     option.series[0].data=[]
                //     alarmAllProvince()
                //     initEcharts('china', '中国')
                // },1000*10)
                myChart.on('click', function (param) {
                    cityInfo(param.name);
                    if (param.data && param.data.provinceKey) {
                        var key = param.data.provinceKey;
                        if (provinceData.length) {
                            $('#back').removeClass('hidden');
                            for (let i = 0; i < provincesText.length; i++) {
                                if (param.name === provincesText[i]) {
                                    mapName = provincesText[i];
                                    mapKey = provinces[i];
                                    mapProvince = param.name;
                                    showProvince(provinces[i], provincesText[i]);
                                    break;
                                }
                            }
                        }
                    }
                    oBack.onclick = function () {
                        $('#back').addClass('hidden');
                        mapName = '';
                        $('#tableNode').empty().html();
                        alarmAllProvince();
                        initEcharts("china", "中国");
                    };
                });

            }
            if (pName !== "china") {
                myChart.on('click', function (params) {
                    if (params === '重庆市' || '北京市' || '上海市' || '天津市') {
                        cq(params.name);
                    }
                    $('#back').removeClass('hidden');
                    $('#china-map').removeClass('content').addClass('hidden');
                    $('#station').removeClass('hidden').addClass('content');
                    stationInfo(params.name);
                    oBack.onclick = function () {
                        $('#stationInfo').empty().html();
                        $('#station').removeClass('content').addClass('hidden');
                        $("#china-map").removeClass('hidden').addClass('content')
                        // showProvince(mapKey,mapProvince);
                        initEcharts(mapProvince);
                        $('#back').removeClass('hidden');
                        oBack.onclick = function () {
                            $('#back').addClass('hidden');
                            $('#tableNode').empty().html();
                            alarmAllProvince();
                            mapName = '';
                            initEcharts("china", "中国");
                        };
                    }
                });
            }
            myChart.hideLoading(); // loading end
        }

        // 展示对应的省
        function showProvince(pName, Chinese_) {
            //这写省份的js都是通过在线构建工具生成的，保存在本地，需要时加载使用即可，最好不要一开始全部直接引入。
            loadBdScript('$' + pName + 'JS', './js/map/province/' + pName + '.js', function () {
                initEcharts(Chinese_);
            });
        }

        // 加载对应的JS
        function loadBdScript(scriptId, url, callback) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            if (script.readyState) { //IE
                script.onreadystatechange = function () {
                    if (script.readyState === "loaded" || script.readyState === "complete") {
                        script.onreadystatechange = null;
                        callback();
                    }
                };
            } else { // Others
                script.onload = function () {
                    callback();
                };
            }
            script.src = url;
            script.id = scriptId;
            document.getElementsByTagName("head")[0].appendChild(script);
        };

    </script>

</body>
<script type="text/javascript" src="js/bg.js"></script>
</html>